name: build-test-coveralls

on:
  pull_request:
    branches: ['**']
    paths-ignore: ['**.md']
  push:
    branches: ['**']
    paths-ignore: ['**.md']

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build:
    name: Build and Test
    strategy:
      matrix:
        os: [ubuntu-latest]
        scala: ["2_11", "2_12", "2_13", "3_3"]
        java: [11, 17, 21]
        platform: ["jvm"]
    runs-on: ${{ matrix.os }}
    env:
      VERSION_SPEC: ${{matrix.scala}}-${{matrix.platform}}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

#      - name: Setup Java and Scala
#        uses: olafurpg/setup-scala@v14
#        with:
#          java-version: ${{ matrix.java }}

      - name: Setup Java ${{matrix.java}}
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: ${{matrix.java}}
          cache: sbt

      - name: Compile and Run Tests
        if: ! (matrix.scala == '2_13' && matrix.java == 21)
        run: sbt test-$VERSION_SPEC

      - name: Compile, Run Tests and Generate Code Coverage Reports (2.13 only)
        if: matrix.scala == '2_13' && matrix.java == 21
        run: sbt clean-$VERSION_SPEC coverage test-$VERSION_SPEC

      - name: Aggregate Code Coverage Report (2.13 only)
        if: matrix.scala == '2_13' && matrix.java == 21
        run: sbt coverageAggregate

      - name: Upload Code Coverage Report (2.13 only)
        if: matrix.scala == '2_13' && matrix.java == 21
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
